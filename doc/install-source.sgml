<sect1 id="installation-source" xreflabel="Installing from source code">
 <title>Installing BDR from source</title>

 <sect2 id="installation-source-extension">
  <title>Installation from source for Postgres-BDR 9.4</>

  <para>
   This section discusses installing BDR on PostgreSQL 9.6+. For instructions
   on installing BDR-Postgres 9.4 and BDR for 9.4, see <xref
   linkend="installation-bdr-source-94">. Confused? See <xref
   linkend="install-requirements">.
  </para>

  <sect3 id="installation-source-prereqs">
   <title>Prerequisites for installing from source</title>
   <para>
    To install BDR on PostgreSQL 9.6, you need PostgreSQL 9.6 installed. If you
    installed PostgreSQL from packages (either distributor packages or
    postgresql.org packages) you will also generally need a -dev or -devel
    package, the name of which depends on your OS and which PostgreSQL packages
    you installed.
   </para>

   <para>
    For <ulink url="http://apt.postgresql.org/">apt.postgresql.org</> packages,
    install <literal>postgresql-server-dev-9.6</>. For <ulink url="http://yum.postgresql.org">
    yum.postgresql.org</> packages, install <literal>postgresql96-devel</>. (Or just
    <link linkend="installation-packages">install BDR from packages</>). For
    other package origins, see their documentation; you need the package that
    contains <filename>postgres.h</> and <filename>pg_config</>.
   </para>

  </sect3>

  <sect3 id="installation-get-source">
   <title>Getting BDR source code</title>

   <sect4>
    <title>Using <application>git</application> to get the BDR sources</title>

    <para>
     Use <application><ulink url="http://git-scm.org">git</ulink></application> if you expect
     to update often, you want to keep track of development or if you want to contribute
     changes to BDR. There is no reason <emphasis>not</emphasis> to use <application>git</application>
     if you're familiar with it.
    </para>

    <para>
     The source for BDR is maintained at
     <ulink url="https://github.com/2ndQuadrant/bdr">https://github.com/2ndQuadrant/bdr</ulink>.
     At the time of writing the main branches of interest are:
     <itemizedlist>
      <listitem><para><filename>bdr-plugin/RELX_Y_STABLE</filename>:
	 the stable releases of the BDR plugin (for example
	 <filename>bdr-plugin/REL2_0_STABLE</filename> is latest source of 2.0.x).</para></listitem>
      <listitem><para><filename>bdr-plugin/next</filename>:
	 the in-progress development version of the BDR plugin</para></listitem>
     </itemizedlist>
    </para>

    <para>
     There are also tags for each BDR release, e.g. <filename>bdr-plugin/2.0.0</filename>.
    </para>

    <para>
     To clone the source code using <application>git</application>:
     <programlisting>
      git clone -b bdr-plugin/REL2_0_STABLE https://github.com/2ndQuadrant/bdr.git bdr-plugin
     </programlisting>
    </para>

    <para>
     For more information on using <application>git</application> see
     <ulink url="http://git-scm.org/">git-scm.org</ulink>.
    </para>

   </sect4>

   <sect4>
    <title>Downloading release source tarballs</title>

    <para>
     Official BDR release source code is uploaded as tarballs to the
     BDR website along with a tarball checksum and a matching GnuPG
     signature. See
     <ulink url="http://2ndquadrant.com/bdr">http://2ndquadrant.com/bdr</ulink>
     for the download information. See <xref linkend="appendix-signatures">
     for information on verifying digital signatures.
    </para>

    <para>
     When installing BDR 2.0 on PostgreSQL 9.6, you <emphasis>only</> need the
     BDR extension sources in the <filename>bdr-[...].tar.gz</filename> archive.
     Ignore the <filename>postgresql-bdr-[...].tar.gz</filename> containing
     BDR-Postgres 9.4, as this is not required when installing on PostgreSQL 9.6.
    </para>

    <para>
     You may optionally verify the package checksums from the
     <literal>.md5</literal> files and/or verify the GnuPG signatures
     per <xref linkend="appendix-signatures">.
    </para>

    <para>
     After you unpack the source code archives using <literal>tar xf</literal>
     the installation process is the same as if you were installing from a git
     clone.
    </para>

   </sect4>

  </sect3>

  <sect3 id="installation-bdr-source">
   <title>Installation of BDR for PostgreSQL 9.6 from source</title>

   <para>
    To add the BDR 2.0 extension to your PostgreSQL 9.6 install execute its
    configure script with the <application>pg_config</application> from
    PostgreSQL 9.6 in the <literal>PATH</literal> environment variable,
    e.g.:
    <programlisting>
     cd /path/to/bdr-plugin-source/
     PATH=/path/to/postgres96/install/bin:"$PATH" ./configure
     make -j4 -s all
     make -s install
    </programlisting>
   </para>

  </sect3>

 </sect2>



 <sect2 id="installation-source-94">
  <title>Installation from source for Postgres-BDR 9.4</>

  <para>
   This section discusses installing BDR and BDR-Postgres 9.4. This is mainly
   useful and necessary for users upgrading from BDR 1.0. New BDR users should
   prefer to <link linkend="installation-source-extension">install BDR as an
   extension to PostgreSQL 9.6</>.
  </para>

  <sect3 id="installation-source-prereqs-94">
   <title>Prerequisites for installing from source</title>
   <para>
    To install Postgres-BDR 9.4 and the BDR extension the prerequisites for
    compiling PostgreSQL must be installed. These are described in PostgreSQL's
    documentation
    on <ulink url="http://www.postgresql.org/docs/current/install-requirements.html">build requirements</ulink>
    and <ulink url="http://www.postgresql.org/docs/current/docguide-toolsets.html">build requirements for documentation</ulink>.
   </para>

   <para>
    On several systems the prerequisites for compiling Postgres-BDR and the BDR
    extension can be installed using simple commands.

    <itemizedlist spacing="compact" mark="bullet">
     <listitem>
      <para>
       <literal>Debian</literal> and <literal>Ubuntu</literal>: First
       add the <ulink
       url="http://apt.postgresql.org/">apt.postgresql.org</ulink>
       repository to your <filename>sources.list</filename> if you
       have not already done so. Then install the pre-requisites for
       building PostgreSQL with:
       <programlisting>
	sudo apt-get update
	sudo apt-get build-dep postgresql-9.4
       </programlisting>
       </para>
     </listitem>
     <listitem>
      <para>
       <literal>RHEL or CentOS 6.x or 7.x</literal>: install the appropriate repository RPM
       for your system from <ulink url="http://yum.postgresql.org/repopackages.php">
       yum.postgresql.org</ulink>. Then install the prerequisites for building
       PostgreSQL with:
       <programlisting>
	sudo yum check-update
	sudo yum groupinstall "Development Tools"
	sudo yum install yum-utils openjade docbook-dtds docbook-style-dsssl docbook-style-xsl
       sudo yum-builddep postgresql94
      </programlisting>
     </para>
    </listitem>

   </itemizedlist>
  </para>
  </sect3>

  <sect3 id="installation-get-source-94">
   <title>Getting BDR source code</title>

   <sect4>
    <title>Using <application>git</application> to get the BDR sources</title>

    <para>
     Use <application><ulink url="http://git-scm.org">git</ulink></application> if you expect
     to update often, you want to keep track of development or if you want to contribute
     changes to BDR. There is no reason <emphasis>not</emphasis> to use <application>git</application>
     if you're familiar with it.
    </para>

    <para>
     The source for BDR is maintained at
     <ulink url="https://github.com/2ndQuadrant/bdr">https://github.com/2ndQuadrant/bdr</ulink>.
     There are actually two independent source trees in this repository - one
     tree for the BDR plugin, and one for the modified version of PostgreSQL, Postgres-BDR 9.4
     that it requires when run on PostgreSQL 9.4. (If you want to run BDR on PostgreSQL 9.6+,
     you can just install it as an extension instead; see <xref
     linkend="installation-source">.) At the time of writing the main branches
     are:
     <itemizedlist>
      <listitem><para><filename>bdr-plugin/RELX_Y_STABLE</filename>:
	 the stable releases of the BDR plugin (for example
	 <filename>bdr-plugin/REL2_0_STABLE</filename> is latest source of 2.0.x).</para></listitem>
      <listitem><para><filename>bdr-plugin/next</filename>:
	 the in-progress development version of the BDR plugin</para></listitem>
      <listitem><para><filename>bdr-pg/REL9_4_STABLE</filename>:
	 the current stable release of the modified PostgreSQL 9.4 that BDR requires.</para></listitem>
     </itemizedlist>
    </para>

    <para>
     There are also tags for each BDR release, e.g. <filename>bdr-plugin/2.0.0</filename>.
    </para>

    <para>
     To clone the source code using <application>git</application> you will
     need to run two clones, one for the BDR plugin sources and one for the
     patched PostgreSQL sources, e.g. (for the 2.0.x version of BDR):
     <programlisting>
      git clone -b bdr-pg/REL9_4_STABLE https://github.com/2ndQuadrant/bdr.git postgresql-bdr
      git clone -b bdr-plugin/REL2_0_STABLE https://github.com/2ndQuadrant/bdr.git bdr-plugin
     </programlisting>
    </para>

    <para>
     For more information on using <application>git</application> see
     <ulink url="http://git-scm.org/">git-scm.org</ulink>.
    </para>

   </sect4>

   <sect4>
    <title>Downloading release source tarballs</title>

    <para>
     Official BDR release source code is uploaded as tarballs to the
     BDR website along with a tarball checksum and a matching GnuPG
     signature. See
     <ulink url="http://2ndquadrant.com/bdr">http://2ndquadrant.com/bdr</ulink>
     for the download information. See <xref linkend="appendix-signatures">
     for information on verifying digital signatures.
    </para>

    <para>
     You will need to download <emphasis>both</emphasis> the patched
     PostgreSQL source (<filename>postgresql-bdr-[...].tar.gz</filename>) and
     the associated BDR release (<filename>bdr-[...].tar.gz</filename>).
    </para>

    <para>
     You may optionally verify the package checksums from the
     <literal>.md5</literal> files and/or verify the GnuPG signatures
     per <xref linkend="appendix-signatures">.
    </para>

    <para>
     After you unpack the source code archives using <literal>tar xf</literal>
     the installation process is the same as if you were installing from a git
     clone.
    </para>

   </sect4>

  </sect3>

 <sect3 id="installation-bdr-source-94">
  <title>Installation of BDR for Postgres-BDR 9.4 from source</title>
  <para>
   Installing BDR for 9.4 from source consists out of two steps: First
   compile and install Postgres-BDR 9.4; secondly compile and install the BDR
   plugin.
  </para>

  <para>
   The patched PostgreSQL 9.4 required for BDR on 9.4 can be compiled using the
   <ulink
   url="http://www.postgresql.org/docs/current/static/installation.html">normal
   documented procedures</ulink>. That will usually be something
   like:
   <programlisting>
    cd /path/to/bdr-pg-source/
    ./configure --prefix=/path/to/install --enable-debug --with-openssl
    make -j4 -s install-world
   </programlisting>
  </para>
  <para>
   To then install BDR execute its configure script with the
   <application>pg_config</application> installed by the patched PostgreSQL
   in the <literal>PATH</literal> environment variable, e.g.:
   <programlisting>
    cd /path/to/bdr-plugin-source/
    PATH=/path/to/postgres/install/bin:"$PATH" ./configure
    make -j4 -s all
    make -s install
   </programlisting>
  </para>
 </sect3>

 </sect2>

</sect1>
