<chapter id="ddl-replication" xreflabel="DDL replication">
 <title>DDL Replication</title>
 <indexterm>
  <primary>DDL Replication</primary>
 </indexterm>

 <para>
  &bdr; supports replicating changes to
  a database's schemas to other connected nodes. That allows to
  quite easily make certain DDL changes without worrying about
  having to deploy them on other nodes first (which is not
  always possible).
 </para>

 <para>
  To safely manipulate the database schema in a asynchronous
  multimaster setup, all pending changes have to be replicated
  first. Otherwise it can e.g. happen that a column constains
  data for a row that has been dropped, or no data for a row
  that is marked NOT NULL. To handle that
  problem, &bdr; acquires a so called
  DDL lock the first time in a transaction schema changes are
  moade.
 </para>

 <para>
  Acquiring such a DDL locks requires contacting all nodes in a
  configiuration setup, asking them to replicate all pending
  changes, and prevent further changes from being made. Once all
  nodes are in that state, the originator of the DDL lock is
  free to perform schema changes.
 </para>

 <para>
  This means that schema changes, in contrary to data changes,
  can only be performed while all configured nodes are
  reachable. If DDL has to be performed while a node is down, it
  has to be removed from the configuration (using
  bdr.bdr_part_by_node_names <!-- FIXME: link once
                                  documented-->) first.
 </para>

 <sect1>
  <title>Statement specific DDL replication concerns</title>

  <para>
   Not all commands can be replicated automatically. Some are
   allowed regardless - generally ones that have affect on more
   than one database -, others are disallowed.
  </para>

  <sect2>
   <title>Not replicated DDL statements</title>

   <para>
    The following DDL statements are not replicated:

    <variablelist>

     <varlistentry id="ddl-create-database">
      <term><varname>CREATE DATABASE</varname>
       <indexterm>
        <primary><varname>CREATE DATABASE</varname></primary>
       </indexterm>
      </term>
      <listitem>
       <para>
        <literal>CREATE DATABASE</literal> cannot be
        replicated because &bdr;
        works on a per database level.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry id="ddl-create-role">
      <term><varname>CREATE ROLE/USER/GROUP</varname>
       <indexterm>
        <primary><varname>CREATE ROLE</varname></primary>
       </indexterm>
       <indexterm>
        <primary><varname>CREATE USER</varname></primary>
       </indexterm>
       <indexterm>
        <primary><varname>CREATE GROUP</varname></primary>
       </indexterm>
      </term>
      <listitem>
       <para>
        <literal>CREATE ROLE</literal> cannot be replicated
        because &bdr; works on a
        per database level. It is possible that a workaround
        for this will be added.
       </para>
       <warning>
        <para>
         Not creating roles of the same name (not
         necessarily with the same access details otherwise
         though) on all systems can break replication when
         statements like <literal>ALTER TABLE ...
          OWNER TO</literal> are replicated.
        </para>
       </warning>
      </listitem>
     </varlistentry>

     <varlistentry id="ddl-create-tablespace">
      <term><varname>CREATE TABLESPACE</varname>
       <indexterm>
        <primary><varname>CREATE TABLESPACE</varname></primary>
       </indexterm>
      </term>
      <listitem>
       <para>
        <literal>CREATE TABLESPACE</literal> cannot be
        replicated because &bdr;
        works on a per database level.
       </para>
       <warning>
        <para>
         Not creating tablespaces of the same name (not
         necessarily with the same location though) on all
         systems can break replication when statements
         like <literal>ALTER TABLE ... SET
          TABLESPACE</literal> are replicated.
        </para>
       </warning>
      </listitem>
     </varlistentry>

     <varlistentry id="ddl-drop-database">
      <term><varname>DROP DATABASE</varname>
       <indexterm>
        <primary><varname>DROP DATABASE</varname></primary>
       </indexterm>
      </term>
      <listitem>
       <para>
        <literal>DROP DATABASE</literal> cannot be
        replicated because &bdr;
        works on a per database level.
       </para>
       <para>
        Note that a database that is configured for &bdr; cannot be
        dropped while that is the case.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry id="ddl-drop-tablespace">
      <term><varname>DROP TABLESPACE</varname>
       <indexterm>
        <primary><varname>DROP TABLESPACE</varname></primary>
       </indexterm>
      </term>
      <listitem>
       <para>
        <literal>DROP TABLESPACE</literal> cannot be
        replicated because &bdr;
        works on a per database level.
       </para>
       <warning>
        <para>
         Dropping tablespaces only on some nodes can cause
         problems when relations on other nodes are moved
         into the tablespace that does not exist locally
         anymore.
        </para>
       </warning>
      </listitem>
     </varlistentry>

     <varlistentry id="ddl-drop-role">
      <term><varname>DROP ROLE/USER/GROUP</varname>
       <indexterm>
        <primary><varname>DROP ROLE</varname></primary>
       </indexterm>
       <indexterm>
        <primary><varname>DROP USER</varname></primary>
       </indexterm>
       <indexterm>
        <primary><varname>DROP GROUP</varname></primary>
       </indexterm>
      </term>
      <listitem>
       <para>
        <literal>DROP ROLE</literal> cannot be replicated
        because &bdr; works on a
        per database level. It is possible that a workaround
        for this will be added.
       </para>
       <warning>
        <para>
         Dropping role only on some nodes can cause
         problems when objects on other nodes are assigned
         to roles that do not exist locally anymore.
        </para>
       </warning>
      </listitem>
     </varlistentry>

     <varlistentry id="ddl-alter-role">
      <term><varname>ALTER ROLE/USER/GROUP</varname>
       <indexterm>
        <primary><varname>ALTER ROLE</varname></primary>
       </indexterm>
       <indexterm>
        <primary><varname>ALTER USER</varname></primary>
       </indexterm>
       <indexterm>
        <primary><varname>ALTER GROUP</varname></primary>
       </indexterm>
      </term>
      <listitem>
       <para>
        <literal>ALTER ROLE</literal> cannot be replicated
        because &bdr; works on a
        per database level. It is possible that a workaround
        for this will be added.
       </para>
       <para>
        Normally all commands but <literal>ALTER ROLE
         ... RENAME TO ...</literal> should be safe to
        execute in the sense that doing so won't cause
        replication to break.
       </para>
       <warning>
        <para>
         Renaming a role only on some nodes can lead to
         problems due to replicated DDL statmeents not
         being able to execute anymore.
        </para>
       </warning>
      </listitem>
     </varlistentry>

     <varlistentry id="ddl-alter-database">
      <term><varname>ALTER DATABASE</varname>
       <indexterm>
        <primary><varname>ALTER DATABASE</varname></primary>
       </indexterm>
      </term>
      <listitem>
       <para>
        <literal>ALTER DATABASE</literal> cannot be replicated
        because &bdr; works on a
        per database level.
       </para>
       <para>
        In practice the primary problematic case is when trying to
        change settings on a per database basis using <literal>ALTER
         DATABASE ... SET ...</literal>, these have to be executed on
        every database for now.
       </para>
       <warning>
        <para>
         Renaming a database can lead to the connection
         information stored on some of the nodes not being
         valid anymore.
        </para>
       </warning>
      </listitem>
     </varlistentry>

     <varlistentry id="ddl-alter-tablespace">
      <term><varname>ALTER TABLESPACE</varname>
       <indexterm>
        <primary><varname>ALTER TABLESPACE</varname></primary>
       </indexterm>
      </term>
      <listitem>
       <para>
        <literal>ALTER TABLSPACE</literal> cannot be replicated
        because &bdr; works on a per
        database level. It is safe to execute on the individual
        nodes though.
       </para>
      </listitem>
     </varlistentry>

    </variablelist>
   </para>
  </sect2>

  <sect2>
   <title>Prohibited DDL statements</title>

   <para>

    <variablelist>

     <varlistentry id="ddl-create-table-as">
      <term><varname>CREATE TABLE AS/SELECT INTO</varname>
       <indexterm>
        <primary><varname>CREATE TABLE AS</varname></primary>
       </indexterm>
       <indexterm>
        <primary><varname>SELECT INTO</varname></primary>
       </indexterm>
      </term>
      <listitem>
       <para>
        <literal>CREATE TABLE AS/SELECT INTO</literal> are
        prohibited unless <literal>UNLOGGED</literal>
        or <literal>UNLOGGED</literal> temporary is specified.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry id="ddl-create-table-of-type">
      <term><varname>CREATE TABLE ... OF TYPE</varname>
       <indexterm>
        <primary><varname>CREATE TABLE ... OF TYPE</varname></primary>
       </indexterm>
      </term>
      <listitem>
       <para>
        <literal>CREATE TABLE ... OF TYPE</literal> is prohibited
        unless <literal>UNLOGGED</literal>
        or <literal>UNLOGGED</literal> temporary is specified.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry id="ddl-create-text-search-parser">
      <term><varname>CREATE TEXT SEARCH PARSER</varname>
       <indexterm>
        <primary><varname>CREATE TEXT SEARCH PARSER</varname></primary>
       </indexterm>
      </term>
      <listitem>
       <para>
        <literal>CREATE TEXT SEARCH PARSER</literal> is prohibited.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry id="ddl-create-text-search-dictionary">
      <term><varname>CREATE TEXT SEARCH DICTIONARY</varname>
       <indexterm>
        <primary><varname>CREATE TEXT SEARCH DICTIONARY</varname></primary>
       </indexterm>
      </term>
      <listitem>
       <para>
        <literal>CREATE TEXT SEARCH DICTIONARY</literal> is
        prohibited.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry id="ddl-alter-text-search-dictionary">
      <term><varname>ALTER TEXT SEARCH DICTIONARY</varname>
       <indexterm>
        <primary><varname>ALTER TEXT SEARCH DICTIONARY</varname></primary>
       </indexterm>
      </term>
      <listitem>
       <para>
        <literal>ALTER TEXT SEARCH DICTIONARY</literal> is
        prohibited.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry id="ddl-create-text-search-template">
      <term><varname>CREATE TEXT SEARCH TEMPLATE</varname>
       <indexterm>
        <primary><varname>CREATE TEXT SEARCH TEMPLATE</varname></primary>
       </indexterm>
      </term>
      <listitem>
       <para>
        <literal>CREATE TEXT SEARCH TEMPLATE</literal> is
        prohibited.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry id="ddl-create-text-search-configuration">
      <term><varname>CREATE TEXT SEARCH CONFIGURATION</varname>
       <indexterm>
        <primary><varname>CREATE TEXT SEARCH CONFIGURATION</varname></primary>
       </indexterm>
      </term>
      <listitem>
       <para>
        <literal>CREATE TEXT SEARCH template</literal> is
        prohibited.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry id="ddl-alter-text-search-configuration">
      <term><varname>ALTER TEXT SEARCH CONFIGURATION</varname>
       <indexterm>
        <primary><varname>ALTER TEXT SEARCH CONFIGURATION</varname></primary>
       </indexterm>
      </term>
      <listitem>
       <para>
        <literal>ALTER TEXT SEARCH template</literal> is prohibited.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry id="ddl-create-collation">
      <term><varname>CREATE COLLATION</varname>
       <indexterm>
        <primary><varname>CREATE COLLATION</varname></primary>
       </indexterm>
      </term>
      <listitem>
       <para>
        <literal>CREATE CREATE COLLATION</literal> is prohibited.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry id="ddl-alter-extension">
      <term><varname>ALTER EXTENSION</varname>
       <indexterm>
        <primary><varname>ALTER INDEX</varname></primary>
       </indexterm>
      </term>
      <listitem>
       <para>
        <literal>ALTER EXTENSION</literal> currently is prohibited.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry id="ddl-create-foreign-data-wrapper">
      <term><varname>CREATE FOREIGN DATA WRAPPER</varname>
       <indexterm>
        <primary><varname>CREATE FOREIGN DATA WRAPPER</varname></primary>
       </indexterm>
      </term>
      <listitem>
       <para>
        <literal>CREATE FOREIGN DATA WRAPPER</literal> currently is prohibited.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry id="ddl-alter-foreign-data-wrapper">
      <term><varname>ALTER FOREIGN DATA WRAPPER</varname>
       <indexterm>
        <primary><varname>ALTER FOREIGN DATA WRAPPER</varname></primary>
       </indexterm>
      </term>
      <listitem>
       <para>
        <literal>ALTER FOREIGN DATA WRAPPER</literal> currently is
        prohibited.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry id="ddl-create-server">
      <term><varname>CREATE SERVER</varname>
       <indexterm>
        <primary><varname>CREATE SERVER</varname></primary>
       </indexterm>
      </term>
      <listitem>
       <para>
        <literal>CREATE SERVER</literal> currently is prohibited.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry id="ddl-alter-server">
      <term><varname>ALTER SERVER</varname>
       <indexterm>
        <primary><varname>ALTER SERVER</varname></primary>
       </indexterm>
      </term>
      <listitem>
       <para>
        <literal>ALTER SERVER</literal> currently is
        prohibited.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry id="ddl-create-user-mapping">
      <term><varname>CREATE USER MAPPING</varname>
       <indexterm>
        <primary><varname>CREATE USER MAPPING</varname></primary>
       </indexterm>
      </term>
      <listitem>
       <para>
        <literal>CREATE USER MAPPING</literal> currently is prohibited.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry id="ddl-alter-user-mapping">
      <term><varname>ALTER USER MAPPING</varname>
       <indexterm>
        <primary><varname>ALTER USER MAPPING</varname></primary>
       </indexterm>
      </term>
      <listitem>
       <para>
        <literal>ALTER USER MAPPING</literal> currently is
        prohibited.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry id="ddl-drop-user-mapping">
      <term><varname>DROP USER MAPPING</varname>
       <indexterm>
        <primary><varname>DROP USER MAPPING</varname></primary>
       </indexterm>
      </term>
      <listitem>
       <para>
        <literal>DROP USER MAPPING</literal> currently is
        prohibited.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry id="ddl-refresh-materialized-view">
      <term><varname>REFRESH MATERIALIZED VIEW</varname>
       <indexterm>
        <primary><varname>REFRESH MATERIALIZED VIEW</varname></primary>
       </indexterm>
      </term>
      <listitem>
       <para>
        <literal>REFRESH MATERIALIZED VIEW</literal> currently is
        prohibited.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry id="ddl-create-language">
      <term><varname>CREATE LANGUAGE</varname>
       <indexterm>
        <primary><varname>CREATE LANGUAGE</varname></primary>
       </indexterm>
      </term>
      <listitem>
       <para>
        <literal>CREATE LANGUAGE</literal> currently is
        prohibited. Note that nearly all procedual languages are
        available as an extension and <literal>CREATE
         EXTENSION</literal> is supported.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry id="ddl-create-conversion">
      <term><varname>CREATE CONVERSION</varname>
       <indexterm>
        <primary><varname>CREATE CONVERSION</varname></primary>
       </indexterm>
      </term>
      <listitem>
       <para>
        <literal>CREATE CONVERSION</literal> currently is
        prohibited.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry id="ddl-create-cast">
      <term><varname>CREATE CAST</varname>
       <indexterm>
        <primary><varname>CREATE CAST</varname></primary>
       </indexterm>
      </term>
      <listitem>
       <para>
        <note><para>
          <literal>CREATE CAST</literal> currently is prohibited. Note
          that <literal>CREATE CAST</literal> inside an extension is
          supported.
        </para></note>
       </para>
      </listitem>
     </varlistentry>

     <varlistentry id="ddl-create-operator-family">
      <term><varname>CREATE OPERATOR FAMILY</varname>
       <indexterm>
        <primary><varname>CREATE OPERATOR FAMILY</varname></primary>
       </indexterm>
      </term>
      <listitem>
       <para>
        <note><para>
          <literal>CREATE OPERATOR FAMILY</literal> currently is prohibited. Note
          that <literal>CREATE OPERATOR FAMILY</literal> inside an extension is
          supported.
        </para></note>
       </para>
      </listitem>
     </varlistentry>

     <varlistentry id="ddl-alter-operator-family">
      <term><varname>ALTER OPERATOR FAMILY</varname>
       <indexterm>
        <primary><varname>ALTER OPERATOR FAMILY</varname></primary>
       </indexterm>
      </term>
      <listitem>
       <para>
        <literal>ALTER OPERATOR FAMILY</literal> currently is
        prohibited.
        <note><para>
          Note that <literal>ALTER OPERATOR FAMILY</literal> inside an extension is supported.
        </para></note>
       </para>
      </listitem>
     </varlistentry>

     <varlistentry id="ddl-create-operator-class">
      <term><varname>CREATE OPERATOR CLASS</varname>
       <indexterm>
        <primary><varname>CREATE OPERATOR CLASS</varname></primary>
       </indexterm>
      </term>
      <listitem>
       <para>
        <literal>CREATE OPERATOR CLASS</literal> currently is
        prohibited.
        <note><para>
          Note that <literal>CREATE OPERATOR CLASS</literal> inside
          an extension is supported.
        </para></note>
       </para>
      </listitem>
     </varlistentry>

     <varlistentry id="ddl-drop-owned">
      <term><varname>DROP OWNED</varname>
       <indexterm>
        <primary><varname>DROP OWNED</varname></primary>
       </indexterm>
      </term>
      <listitem>
       <para>
        <literal>DROP OWNED</literal> is prohibited.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry id="ddl-security-label">
      <term><varname>SECURITY LABEL</varname>
       <indexterm>
        <primary><varname>SECURITY LABEL</varname></primary>
       </indexterm>
      </term>
      <listitem>
       <para>
        Except for some &bdr; internal use <literal>SECURITY
         LABEL</literal> is prohibited.
       </para>
      </listitem>
     </varlistentry>

    </variablelist>
   </para>
  </sect2>

  <sect2>
   <title>DDL statements with restrictions</title>

   <para>
    Generally unsupported statements are prevented from being
    executed, raising a 0A000/feature_not_supported error.

    <variablelist>

     <varlistentry id="ddl-create-table">
      <term><varname>CREATE TABLE</varname>
       <indexterm>
        <primary><varname>CREATE TABLE</varname></primary>
       </indexterm>
      </term>
      <listitem>
       <para>
        Generally <literal>CREATE TABLE</literal> is allowed. There
        are a few options/subcommands that are not supported.

        Not supported commands are:
        <itemizedlist spacing="compact" mark="bullet">
         <listitem>
          <para>
           <literal>WITH OIDS</literal> - outdated option, not deemed worth to add support for
          </para>
         </listitem>

         <listitem>
          <para>
           <literal>OF TYPE</literal> - not supported yet
          </para>
         </listitem>

         <listitem>
          <para>
           <literal>CONSTRAINT ... EXCLUDE</literal> - not supported yet
          </para>
         </listitem>
        </itemizedlist>

       </para>
      </listitem>
     </varlistentry>

     <varlistentry id="ddl-alter-table">
      <term><varname>ALTER TABLE</varname>
       <indexterm>
        <primary><varname>ALTER TABLE</varname></primary>
       </indexterm>
      </term>
      <listitem>
       <para>
        Generally <literal>ALTER TABLE</literal> commands are
        allowed. There are a however several subcommands that are
        not supported.

        Not supported commands are:
        <itemizedlist spacing="compact" mark="bullet">
         <listitem>
          <para>
           <literal>ADD COLUMN ... DEFAULT</literal> - this option
           can unfortunately not be supported. It is however often
           possible to rewrite this into several, supported,
           commands:
           <programlisting>
            BEGIN;
            ALTER TABLE mtab ADD COLUMN newcol;
            UPDATE mtab SET newcol = default_value;
            ALTER TABLE mtab ALTER COLUMN newcal SET DEFAULT default_value;
           </programlisting>
           If preexisiting rows do not need the default value, the
           UPDATE can obviously be avoided. In that case doing
           separate <literal>ADD COLUMN</literal> and <literal>ALTER
            COLUMN ... SET DEFAULT</literal> commands are
           advantageous anyway as they don't rewrite the whole
           table.
          </para>
         </listitem>

         <listitem>
          <para>
           <literal>ADD CONSTRAINT ... EXCLUDE</literal> - exclusion
           are not supported for now.
          </para>
         </listitem>

         <listitem>
          <para>
           <literal>ALTER CONSTRAINT</literal> - changing constraint
           settings is not supported for now.
          </para>
         </listitem>

         <listitem>
          <para>
           <literal>ALTER COLUMN ... TYPE</literal> - changing a
           column's type is not supported. Chaning a column in a way
           that doesn't require table rewrites may be suppported at
           some point.
          </para>
         </listitem>

         <listitem>
          <para>
           <literal>ENABLE .. RULE</literal> - is not supported.
          </para>
         </listitem>

         <listitem>
          <para>
           <literal>DISABLE .. RULE</literal> - is not supported.
          </para>
         </listitem>

         <listitem>
          <para>
           <literal>[NO] INHERIT</literal> - is not supported.
          </para>
         </listitem>

         <listitem>
          <para>
           <literal>[NOT] OF TYPE</literal> - is not supported.
          </para>
         </listitem>

         <listitem>
          <para>
           <literal>ALTER COLUMN ... SET (..)</literal> - is not
           supported at the moment.
          </para>
         </listitem>

         <listitem>
          <para>
           <literal>SET (..)</literal> - is not supported at the
           moment.
          </para>
         </listitem>

        </itemizedlist>

       </para>
      </listitem>
     </varlistentry>

     <varlistentry id="ddl-create-index">
      <term><varname>CREATE INDEX</varname>
       <indexterm>
        <primary><varname>CREATE INDEX</varname></primary>
       </indexterm>
      </term>
      <listitem>
       <para>
        Generally <literal>CREATE INDEX</literal> is supported,
        but <literal>CREATE UNIQUE INDEX ... WHERE</literal>,
        i.e. partial unique indexecs are not allowed.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry id="ddl-create-sequence">
      <term><varname>CREATE SEQUENCE</varname>
       <indexterm>
        <primary><varname>CREATE SEQUENCE</varname></primary>
       </indexterm>
      </term>
      <listitem>
       <para>
        Generally <literal>CREATE SEQUENCE</literal> is supported,
        but when using &bdr;'s distributed sequences, some options
        are prohibited.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry id="ddl-alter-sequence">
      <term><varname>ALTER SEQUENCE</varname>
       <indexterm>
        <primary><varname>ALTER SEQUENCE</varname></primary>
       </indexterm>
      </term>
      <listitem>
       <para>
        Generally <literal>ALTER SEQUENCE</literal> is supported,
        but when using &bdr;'s distributed sequences, some options
        like <literal>START</literal> are prohibited. Several of
        them, like the aforementioned <literal>START</literal> can
        be specified during <literal>CREATE SEQUENCE</literal>.
       </para>
      </listitem>
     </varlistentry>


    </variablelist>
   </para>
  </sect2>
 </sect1>
</chapter>
